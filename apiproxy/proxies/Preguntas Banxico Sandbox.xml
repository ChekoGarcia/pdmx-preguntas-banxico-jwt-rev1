<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ProxyEndpoint name="Preguntas Banxico Sandbox">
    <Description>VPOS</Description>
    <PreFlow name="PreFlow">
        <Request>
            <Step>
                <Name>OPTIONS-CORS-Headers-Response</Name>
                <Condition>request.verb == "OPTIONS"</Condition>
            </Step>
            <Step>
                <Name>ACL</Name>
            </Step>
            <Step>
                <Name>JS-Get-Data</Name>
            </Step>
            <Step>
                <Name>FC-HeadersMtls</Name>
            </Step>
            <Step>
                <Name>KVM-PREGUNTAS-BANXICO</Name>
            </Step>
            <Step>
                <Name>AccessControlDeveloperProducts</Name>
            </Step>
            <Step>
                <Name>Get-Developer-Data</Name>
            </Step>
            <Step>
                <Name>Developer-Quotas</Name>
            </Step>
            <Step>
                <Name>SA-PeticionesSegundo</Name>
            </Step>
            <Step>
                <Name>KVM-Keycloak</Name>
            </Step>
            <Step>
                <Name>emitElapsed</Name>
            </Step>
            <Step>
                <Name>keycloak-cache</Name>
            </Step>
            <Step>
                <Name>JS-Extract-Token</Name>
                <!--aqui-->
            </Step>
            <Step>
                <Name>emitElapsed</Name>
            </Step>
            <Step>
                <Name>AM-elapse-kc</Name>
            </Step>
            <Step>
                <Name>JS-ExtractOtorgante</Name>
            </Step>
            <Step>
                <Name>AM-verifying</Name>
            </Step>
            <Step>
                <Name>EV-Headers</Name>
            </Step>
            <Step>
                <Name>RF-Header-x-signature</Name>
                <Condition>(request.header.x-signature = null) and ( ((proxy.pathsuffix MatchesPath "/") and (request.verb = "POST")) or ((proxy.pathsuffix MatchesPath "/*") and (request.verb = "GET")))</Condition>
            </Step>
            <Step>
                <Name>OAS-ValidateContract</Name>
            </Step>
            <Step>
                <Name>JS-FormatError</Name>
                <Condition>OASValidation.OAS-ValidateContract.failed = true</Condition>
            </Step>
            <Step>
                <Name>RF-ValidateContract</Name>
                <Condition>OASValidation.OAS-ValidateContract.failed = true</Condition>
            </Step>
            <Step>
                <Name>REP-HEADERS</Name>
            </Step>
            <Step>
                <Name>Verifying-signature</Name>
            </Step>
            <Step>
                <Name>emitElapsed</Name>
            </Step>
            <Step>
                <Name>RemoveAcents</Name>
            </Step>
            <Step>
                <Name>JS-Variables-Bitacora</Name>
            </Step>
            <Step>
                <Name>AM-request-post-ine-verificacion</Name>
            </Step>
            <Step>
                <Name>KVM-JWT-LOGIN</Name>
            </Step>
        </Request>
        <Response/>
    </PreFlow>
    <PostFlow name="PostFlow">
        <Request/>
        <Response>
            <Step>
                <Name>ContentType</Name>
            </Step>
            <Step>
                <Name>AM-Response</Name>
                <Condition>response.status.code != 200</Condition>
            </Step>
            <Step>
                <Name>AM-Response-Error-Generic</Name>
                <Condition>response.status.code != 200</Condition>
            </Step>
            <Step>
                <Name>AM-Error404.1</Name>
                <Condition>(response.status.code == 404 and return.contentType.error = false)</Condition>
            </Step>
            <Step>
                <Name>AM-Error503.1</Name>
                <Condition>response.status.code == 503</Condition>
            </Step>
            <Step>
                <Name>AM-Error500.1</Name>
                <Condition>
                    (response.status.code == 500) or (return.contentType.error = true)
                </Condition>
            </Step>
            <Step>
                <Name>Null-request-param</Name>
            </Step>
            <Step>
                <Name>AM-signature</Name>
            </Step>
            <Step>
                <Name>Signaturing</Name>
                <Condition>(response.code == 200) or (response.status.code == 200)</Condition>
            </Step>
            <Step>
                <Name>AM-Singnature-response</Name>
                <Condition>(response.code == 200) or (response.status.code == 200)</Condition>
            </Step>
            <Step>
                <Name>JS-Variables-Bitacora</Name>
            </Step>
            <Step>
                <Name>AM-Add-Header</Name>
            </Step>
            <Step>
                <Name>BIC</Name>
            </Step>
            <Step>
                <Name>FC-BF</Name>
            </Step>
            <Step>
                <Name>EVS-stadistic-response</Name>
            </Step>
            <Step>
                <Name>EVS-stadistic-request</Name>
            </Step>
            <Step>
                <Name>Statistics-Collector</Name>
            </Step>
            <Step>
                <Name>RemoveHeaders</Name>
            </Step>
        </Response>
    </PostFlow>
    <Flows>
        <Flow name="obtener">
            <Description>preguntas</Description>
            <Condition>(proxy.pathsuffix MatchesPath "/obtener") and (request.verb = "POST")</Condition>
            <Request>
                <Step>
                    <Name>Verify-JWT-1</Name>
                </Step>
                <Step>
                    <Name>Decode-JWT-1</Name>
                </Step>
                <Step>
                    <Name>JS-ValidateRequest</Name>
                </Step>
                <Step>
                    <Name>RF-Validation-JWT</Name>
                    <Condition> isValidRequest = false </Condition>
                </Step>
            </Request>
            <Response/>
        </Flow>
        <Flow name="autenticar">
            <Description>autenticar</Description>
            <Condition>(proxy.pathsuffix MatchesPath "/autenticar") and (request.verb = "POST")</Condition>
            <Request>
                <Step>
                    <Name>Verify-JWT-1</Name>
                </Step>
                <Step>
                    <Name>Decode-JWT-1</Name>
                </Step>
                <Step>
                    <Name>JS-ValidateRequest</Name>
                </Step>
                <Step>
                    <Name>RF-Validation-JWT</Name>
                    <Condition> isValidRequest = false </Condition>
                </Step>
            </Request>
            <Response/>
        </Flow>
        <Flow name="obtener-pm">
            <Description>Obtiene datos PM.</Description>
            <Condition>(proxy.pathsuffix MatchesPath "/obtener-pm") and (request.verb = "POST")</Condition>
            <Request>
                <Step>
                    <Name>Verify-JWT-1</Name>
                </Step>
                <Step>
                    <Name>Decode-JWT-1</Name>
                </Step>
                <Step>
                    <Name>JS-ValidateNewHeaderPM</Name>
                </Step>
                <Step>
                    <Name>RF-Validation-JWT</Name>
                    <Condition> jwtMatch = false </Condition>
                </Step>
            </Request>
            <Response/>
        </Flow>
        <Flow name="autenticar-pm">
            <Description>Autentica datos PM.</Description>
            <Condition>(proxy.pathsuffix MatchesPath "/autenticar-pm") and (request.verb = "POST")</Condition>
            <Request>
                <Step>
                    <Name>Verify-JWT-1</Name>
                </Step>
                <Step>
                    <Name>Decode-JWT-1</Name>
                </Step>
                <Step>
                    <Name>JS-ValidateNewHeaderPM</Name>
                </Step>
                <Step>
                    <Name>RF-Validation-JWT</Name>
                    <Condition> jwtMatch = false </Condition>
                </Step>
            </Request>
            <Response/>
        </Flow>
    </Flows>
    <PostClientFlow name="PostClientFlow">
        <Request/>
        <Response>
            <Step>
                <Name>FC-SF-Send-Log</Name>
                <Condition>proxy_settings.logging_enabled == true</Condition>
            </Step>
        </Response>
    </PostClientFlow>
    <HTTPProxyConnection>
        <BasePath>/v1/jwt/preguntas</BasePath>
        <VirtualHost>incapsula</VirtualHost>
    </HTTPProxyConnection>
    <RouteRule name="obtener-RouteRule">
        <Condition>(proxy.pathsuffix MatchesPath "/obtener") and (request.verb = "POST")</Condition>
        <TargetEndpoint>obtener</TargetEndpoint>
    </RouteRule>
    <RouteRule name="autenticar-RouteRule">
        <Condition>(proxy.pathsuffix MatchesPath "/autenticar") and (request.verb = "POST")</Condition>
        <TargetEndpoint>autenticar</TargetEndpoint>
    </RouteRule>
    <RouteRule name="RouteRule-obtener-pm">
        <Condition>(proxy.pathsuffix MatchesPath "/obtener-pm") and (request.verb = "POST")</Condition>
        <TargetEndpoint>obtener-pm</TargetEndpoint>
    </RouteRule>
    <RouteRule name="RouteRule-autenticar-pm">
        <Condition>(proxy.pathsuffix MatchesPath "/autenticar-pm") and (request.verb = "POST")</Condition>
        <TargetEndpoint>autenticar-pm</TargetEndpoint>
    </RouteRule>
    <RouteRule name="noroute"/>
    <FaultRules>
        <FaultRule name="AM-Error400-content">
            <Step>
                <Name>AM-Error400-content</Name>
            </Step>
            <Condition>OASValidation.OAS-ValidateContract.failed = true</Condition>
        </FaultRule>
        <FaultRule name="falta-error-504">
            <!-- CORE failed -->
            <Step>
                <Name>AM-Error504.1</Name>
            </Step>
            <Condition>response.status.code = 504</Condition>
        </FaultRule>
        <FaultRule name="falta-error-500.4">
            <Step>
                <Name>AM-DefaultError</Name>
            </Step>
            <Condition>response.status.code = 500 or (steps.servicecallout.ExecutionFailed = true)</Condition>
        </FaultRule>
        <FaultRule name="falta-error-500.1">
            <!-- Verifying Internal server error -->
            <Step>
                <Name>AM-Error500.1</Name>
            </Step>
            <Condition>(VerifyingResponse.status.code = 500) or (servicecallout.RequestingToken.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="falta-error-500.3">
            <Step>
                <Name>AM-Error500.2</Name>
            </Step>
            <Condition>(fault.name Matches "SourceMessageNotAvailable")</Condition>
        </FaultRule>
        <FaultRule name="falta-error-429.1">
            <!-- Quotas -->
            <Step>
                <Name>AM-Error429.1</Name>
            </Step>
            <Condition>(fault.name = "QuotaViolation") or (ratelimit.SA-PeticionesSegundo.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="IPDeniedAccess">
            <Step>
                <Name>AM-Forbidden</Name>
                <Condition>(fault.name Matches "IPDeniedAccess") </Condition>
            </Step>
            <Condition>(acl.failed = true) </Condition>
        </FaultRule>
        <FaultRule name="400-ValidateJsonRequest">
            <Step>
                <Name>AM-Error400.1</Name>
            </Step>
            <Condition>javascript.error = true or (raisefault.RaiseFault-validation.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="400-JSONThreatProtection">
            <Step>
                <Name>AM-Error400.4</Name>
            </Step>
            <Condition>(steps.messagevalidation.Failed = true or jsonattack.JSON-Threat-Protection-Preguntas-Banxico.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="falta-error-400.4">
            <!-- Verifying bad request -->
            <Step>
                <Name>AM-Error400.4</Name>
            </Step>
            <Condition>VerifyingResponse.status.code = 400</Condition>
        </FaultRule>
        <FaultRule name="fault-405.1">
            <Step>
                <Name>AM-Error405.1</Name>
            </Step>
            <Condition>(raisefault.RF-ApigeeErr-405.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="falta-error-403.1">
            <!-- Verifying forbidden -->
            <Step>
                <Name>AM-Error403.1</Name>
            </Step>
            <Condition>(VerifyingResponse.status.code = 403) or (VerifyingResponse.status.code = 500 or servicecallout.Verifying.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="falta-error-403.3">
            <!-- aplica cuando la verificacion falla -->
            <Step>
                <Name>AM-Error403.2</Name>
            </Step>
            <Condition>tokenResponse.status.code = 500</Condition>
        </FaultRule>
        <FaultRule name="error-token1-401.2">
            <!-- Token Response -->
            <Step>
                <Name>AM-Error401.2</Name>
            </Step>
            <Condition>(tokenResponse.status.code = 401) or (extractvariables.ExtractToken.failed = true) or (JWT.Verify-JWT-1.failed = true)
            </Condition>
        </FaultRule>
        <FaultRule name="falta-error-401.3">
            <!-- Verify Api Key -->
            <Step>
                <Name>AM-Error401.3</Name>
            </Step>
            <Condition>(fault.name Matches "InvalidApiKey")</Condition>
        </FaultRule>
        <FaultRule name="falta-error-401">
            <!-- Verify Api Key -->
            <Step>
                <Name>AM-Error401.1</Name>
            </Step>
            <Condition>(raisefault.RF-RaiseProductValidate.failed = true) or (fault.name Matches "FailedToResolveAPIKey") or (fault.name Matches "InvalidApiKeyForGivenResource")</Condition>
        </FaultRule>
        <FaultRule name="falta-error-401">
            <!-- Verify Api Key -->
            <Step>
                <Name>AM-Error401.1</Name>
            </Step>
            <Condition>(raisefault.JSONThreatProtection.failed = true)</Condition>
        </FaultRule>
        <FaultRule name="400-RequestError">
            <Step>
                <Name>AM-Error400.2</Name>
                <Condition>(fault.name Matches "Failed")</Condition>
            </Step>
            <Condition>(messagevalidation.failed=true)</Condition>
        </FaultRule>
    </FaultRules>
    <DefaultFaultRule>
        <Step>
            <Name>AM-Error500.1</Name>
        </Step>
    </DefaultFaultRule>
    <DefaultFaultRule name="default-fault">
        <Step>
            <Name>FC-SF-Collect-Log-Data</Name>
            <Condition>proxy_settings.logging_enabled == true</Condition>
        </Step>
        <Step>
            <Name>AM-AddCORS</Name>
            <Condition>(raisefault.OPTIONS-CORS-Headers-Response.failed = false) or (raisefault.OPTIONS-CORS-Headers-Response.failed = null)</Condition>
        </Step>
        <AlwaysEnforce>true</AlwaysEnforce>
    </DefaultFaultRule>
</ProxyEndpoint>